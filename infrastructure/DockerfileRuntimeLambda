FROM febiosoftware/febio-runtime:ubuntu-22.04

# Define custom function directory
ARG FUNCTION_DIR="/function"

# Install aws-lambda-cpp build dependencies
RUN apt-get update && \
  apt-get install -y \
  g++ \
  make \
  cmake \
  unzip \
  python3 \
  python3-pip \
  libcurl4-openssl-dev

RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1
RUN update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1

# Copy function code
RUN mkdir -p ${FUNCTION_DIR}
COPY aws-lambda/src/* ${FUNCTION_DIR}

# Copy febio code
COPY ../cmbuild/bin /usr/local/bin/
COPY ../cmbuild/lib /usr/local/lib/

# Install the function's dependencies
RUN pip install \
    --target ${FUNCTION_DIR} \
        awslambdaric
RUN pip install \
    -r ${FUNCTION_DIR}/requirements.txt \
    --target ${FUNCTION_DIR}

ENV PATH "$PATH:/usr/local/bin:/usr/local/lib"
# Set working directory to function root directory
WORKDIR ${FUNCTION_DIR}
ADD https://github.com/aws/aws-lambda-runtime-interface-emulator/releases/latest/download/aws-lambda-rie /usr/bin/aws-lambda-rie
RUN chmod +x /usr/bin/aws-lambda-rie
COPY aws-lambda/entry.sh /

ENTRYPOINT [ "/entry.sh" ]
CMD [ "app.handler" ]
